#!/usr/bin/env ruby
require 'optparse'

require 'eventmachine'
require 'faye/websocket'
require 'rack'
require 'thin'

require 'rrrspec/server'

Faye::WebSocket.load_adapter('thin')

options = {}
OptionParser.new do |opts|
  opts.on("--redis REDIS_URL") do |url|
    options[:redis] = { url: url }
  end

  opts.on("--execute-log-text-path PATH") do |path|
    options[:execute_log_text_path] = File.absolute_path(path)
  end

  opts.on("--json-cache-path PATH") do |path|
    options[:json_cache_path] = File.absolute_path(path)
  end

  opts.on("--port PORT", OptionParser::DecimalInteger) do |port|
    options[:port] = port
  end

  opts.on("--[no-]daemonize") do |v|
    options[:daemonize] = v
  end

  opts.on("--pidfile PATH") do |path|
    options[:pidfile] = path
  end

  opts.on("--[no-]monitor") do |v|
    options[:monitor] = v
  end

  opts.on("--user USER") do |user|
    options[:user] = user
  end

  opts.on("-h", "--help") do
    puts opts
    exit
  end
end.parse!

app = RRRSpec::Server.master_app(options)

RRRSpec::Server.daemonizer('rrrspec-master') do
  thin = Rack::Handler.get('thin')
  thin.run(app, Port: RRRSpec.config.port)
end
