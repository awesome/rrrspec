#!/usr/bin/env ruby
require 'optparse'

require 'eventmachine'

require 'rrrspec/server'

options = {}
OptionParser.new do |opts|
  opts.on("--master-url MASTER_URL") do |url|
    options[:master_url] = url
  end

  opts.on("--rsync-remote-path PATH") do |path|
    options[:rsync_remote_path] = path
  end

  opts.on("--rsync-options PATH") do |path|
    options[:rsync_options] = path
  end

  opts.on("--working-dir PATH") do |path|
    options[:working_dir] = path
  end

  opts.on("--worker-type PATH") do |path|
    options[:worker_type] = path
  end

  opts.on("--slave-processes NUM", OptionParser::DecimalInteger) do |num|
    options[:slave_processes] = num
  end

  opts.on("--[no-]daemonize") do |v|
    options[:daemonize] = v
  end

  opts.on("--pidfile PATH") do |path|
    options[:pidfile] = path
  end

  opts.on("--[no-]monitor") do |v|
    options[:monitor] = v
  end

  opts.on("--help") do
    puts opts
    exit
  end
end.parse!

app = RRRSpec::Server.worker_app(options)

RRRSpec::Server.daemonizer('rrrspec-worker') do
  EM.run { app.run }
end
